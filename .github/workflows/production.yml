name: Production Deployment

on:
  push:
    branches:
      - production  # Deploy when code is pushed to the production branch

jobs:
  deploy-to-server:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set Up SSH and Deploy to Production Server
        run: |
          echo "🔧 Setting up SSH and deploying to production server..."

          # Create the .ssh directory
          mkdir -p ~/.ssh

          # Save the SSH private key
          printf "%s\n" "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa  # Set correct permissions

          # Add server to known hosts (to prevent SSH prompt)
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts 2>/dev/null

          # Debug: Check SSH connection
          echo "🚀 Testing SSH connection..."
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} "echo 'SSH Connection Successful'"

          # Deploy the latest production code
          echo "📦 Deploying the latest production code..."
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} << EOF
            echo "🔧 Navigating to project directory..."
            cd /home/developer/mindfulprod

            echo "🔑 Configuring Git..."
            git config --global --add safe.directory /home/developer/mindfulprod
            git config --global credential.helper store

            # Update Git URL to use the token for authentication
            git remote set-url origin https://x-access-token:${{ secrets.DEPLOY_PAT }}@github.com/sonaldevcodes/mindful.git

            echo "📥 Pulling latest changes from production branch..."
            git pull origin production  

            echo "🛠️ Restarting Docker services..."
            docker compose -f docker-compose.prod.yaml down -v
 
            docker compose -f docker-compose.prod.yaml up --build -d

            echo "🧹 Cleaning up unused Docker resources..."
            docker system prune -af

            echo "✅ Deployment to production completed!"
          EOF